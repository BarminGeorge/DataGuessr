version: '3.8'

services:
postgres:
  image: timescale/timescaledb:latest-pg17
  environment:
    POSTGRES_DB: DataGuessrDB
    POSTGRES_USER: dataguessr_user
    POSTGRES_PASSWORD: YourStrongPassword123
    TIMESCALEDB_TELEMETRY: off
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U dataguessr_user -d DataGuessrDB"]
    interval: 5s
    timeout: 5s
    retries: 10

app:
  depends_on:
    postgres:
      condition: service_healthy

  app:
    build: .
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=DataGuessrDB;Username=dataguessr_user;Password=YourStrongPassword123
    ports:
      - "5000:8080" 
    depends_on:
      - postgres
    restart: always

  caddy:
    image: caddy:latest
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - app

volumes:
  postgres_data:
  caddy_data:
  caddy_config:
